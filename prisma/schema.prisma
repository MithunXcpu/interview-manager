generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                String              @id @default(cuid())
  clerkId           String              @unique
  email             String              @unique
  name              String?
  googleAccessToken String?
  googleRefreshToken String?
  googleTokenExpiry DateTime?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  companies         Company[]
  availabilitySlots AvailabilitySlot[]
  emailTemplates    EmailTemplate[]
  bookingLinks      BookingLink[]
}

model Company {
  id              String            @id @default(cuid())
  userId          String
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  name            String
  website         String?
  stage           InterviewStage    @default(APPLIED)
  recruiterName   String?
  recruiterEmail  String?
  recruiterPhone  String?
  notes           String?
  jobTitle        String?
  jobUrl          String?
  salary          String?
  location        String?
  remote          Boolean           @default(false)
  priority        Priority          @default(MEDIUM)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  emails          Email[]
  interviews      Interview[]

  @@index([userId])
  @@index([stage])
}

model Email {
  id              String        @id @default(cuid())
  companyId       String?
  company         Company?      @relation(fields: [companyId], references: [id], onDelete: SetNull)
  gmailId         String        @unique
  threadId        String
  from            String
  to              String
  subject         String
  snippet         String?
  body            String?
  isRead          Boolean       @default(false)
  isStarred       Boolean       @default(false)
  receivedAt      DateTime
  aiSummary       String?
  aiSuggestedReply String?
  createdAt       DateTime      @default(now())

  @@index([companyId])
  @@index([threadId])
}

model Interview {
  id              String          @id @default(cuid())
  companyId       String
  company         Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  title           String
  type            InterviewType   @default(PHONE_SCREEN)
  scheduledAt     DateTime
  duration        Int             @default(60) // minutes
  location        String?         // physical address or meeting link
  meetingType     MeetingType?
  meetingLink     String?
  calendarEventId String?
  notes           String?
  status          InterviewStatus @default(SCHEDULED)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([companyId])
  @@index([scheduledAt])
}

model AvailabilitySlot {
  id          String      @id @default(cuid())
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  dayOfWeek   Int         // 0-6 (Sunday-Saturday)
  startTime   String      // HH:MM format
  endTime     String      // HH:MM format
  timezone    String      @default("America/New_York")
  isActive    Boolean     @default(true)

  @@index([userId])
}

model BookingLink {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  slug            String    @unique
  title           String    @default("Schedule a meeting")
  description     String?
  duration        Int       @default(30) // minutes
  meetingType     MeetingType @default(GOOGLE_MEET)
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())

  @@index([userId])
  @@index([slug])
}

model EmailTemplate {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String
  subject     String
  body        String
  variables   String[]  // e.g., ["companyName", "recruiterName", "bookingLink"]
  category    String?   // e.g., "availability", "follow-up", "thank-you"
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
}

enum InterviewStage {
  WISHLIST
  APPLIED
  SCREENING
  PHONE_SCREEN
  TECHNICAL
  ONSITE
  OFFER
  REJECTED
  ACCEPTED
  DECLINED
}

enum InterviewType {
  PHONE_SCREEN
  TECHNICAL
  BEHAVIORAL
  SYSTEM_DESIGN
  CODING
  ONSITE
  FINAL
  OFFER_CALL
}

enum InterviewStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  RESCHEDULED
  NO_SHOW
}

enum MeetingType {
  GOOGLE_MEET
  ZOOM
  PHONE
  IN_PERSON
  MICROSOFT_TEAMS
}

enum Priority {
  HIGH
  MEDIUM
  LOW
}
